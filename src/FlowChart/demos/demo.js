/* eslint-disable */
import React, { useState, useCallback } from 'react';
import FlowChart, { addNode, addBranch, expandBranch, combineNodes, deleteNode } from '../index';
import { cloneDeep } from 'lodash-es';
import Toast from '../../Toast';
import Button from '../../Button';
import { uniqueId } from '../../_utils';
import Render from '../Nodes';
import styles from './demo.module.css';

let toastId;

const nodeTitleMap = {
    time: '定时',
    write: '填写',
    send: '发送',
    audit: '审核',
    record: '记录',
    work: '任务',
    operation: '操作'
}

function createNewNode(type) {
    return {
        id: uniqueId('flowchart'),
        type
    };
}

const ToastConfirmDelete = (confirm, cancel) => {
    return (
        <div className={styles.toastContainer} style={{ width: 240 }}>
            <div style={{ fontSize: 16, fontWeight: 700, marginBottom: 12 }}>是否确认删除该节点？</div>
            <Button color="#ff3b3b" variant="text" onClick={cancel}>Cancel</Button>
            <Button color="#1890ff" variant="contained" style={{ marginLeft: 12 }} onClick={confirm}>Confirm</Button>
        </div>
    )
}

const ToastPanel = (update, cancel, canAddBranch) => {
    return (
        <div className={styles.toastContainer}>
            <div>
                <Button color="#2196f3" style={{ width: 84, height: 80, margin: 16 }} onClick={() => update('time')}>
                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center'}}>
                        <svg style={{display: 'block'}} viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14455" width="40" height="40"><path d="M690.43953 332.921415 503.821225 519.578606 381.0736 396.825864c-8.740058-8.739035-22.946618-8.739035-31.686676 0-8.740058 8.741082-8.740058 22.948665 0 31.6877l122.753765 122.749672-35.180244 35.17922c-8.741082 8.741082-8.741082 22.949688 0 31.6877 8.739035 8.734942 22.942525 8.734942 31.68156 0l35.17922-35.17922 35.722596 35.716456c8.734942 8.738012 22.942525 8.738012 31.682583 0 8.740058-8.740058 8.740058-22.948665 0-31.68463l-35.716456-35.719526 186.612165-186.612165c8.740058-8.740058 8.740058-22.947641 0-31.6877C713.382055 324.180334 699.174472 324.180334 690.43953 332.921415L690.43953 332.921415zM510.544347 62.365396c-247.517303 0-448.158996 200.64067-448.158996 448.158996 0 247.517303 200.64067 448.16002 448.158996 448.16002 247.51935 0 448.161043-200.641693 448.161043-448.16002C958.70539 263.006066 758.063697 62.365396 510.544347 62.365396L510.544347 62.365396zM532.951683 912.39004 532.951683 801.826921c0-12.367679-10.037611-22.406313-22.407336-22.406313-12.368702 0-22.406313 10.038634-22.406313 22.406313l0 110.563118C284.718065 901.050784 119.031489 737.337141 108.453572 532.930705l110.789269 0c12.368702 0 22.406313-10.037611 22.406313-22.406313s-10.037611-22.406313-22.406313-22.406313L108.680746 488.11808c12.326746-202.973808 177.245843-368.076076 379.458311-379.595434l0 110.699218c0 12.368702 10.037611 22.406313 22.406313 22.406313 12.370749 0 22.407336-10.038634 22.407336-22.406313L532.952706 108.569718c202.258517 11.519358 367.177614 176.621627 379.505383 379.548362L801.847899 488.11808c-12.369725 0-22.406313 10.038634-22.406313 22.406313s10.037611 22.406313 22.406313 22.406313l110.789269 0C902.058229 737.337141 736.372675 901.050784 532.951683 912.39004L532.951683 912.39004zM532.951683 912.39004" p-id="14456" fill="#2196f3"></path></svg>
                        time
                    </div>
                </Button>
                <Button color="#f759ab" style={{ width: 84, height: 80, margin: 16 }} onClick={() => update('write')}>
                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center'}}>
                        <svg style={{display: 'block'}} viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15994" width="40" height="40"><path d="M343.207178 559.224558c-0.584308 0.74599-1.167592 1.523703-1.427512 2.465145l-45.016263 165.04394c-2.629897 9.608845 0.064468 19.961634 7.173376 27.262924 5.323239 5.192256 12.33391 8.049327 19.798928 8.049327 2.466168 0 4.932336-0.291642 7.366781-0.942465l163.873278-44.692898c0.261966 0 0.391926 0.228197 0.585331 0.228197 1.882883 0 3.733021-0.681522 5.129834-2.111081L938.887019 276.393981c13.016455-13.030781 20.156062-30.78412 20.156062-50.096978 0-21.892613-9.283434-43.767829-25.544793-59.98007l-41.382503-41.446971c-16.226566-16.261359-38.135552-25.560142-60.012815-25.560142-19.308765 0-37.063127 7.141654-50.113351 20.138666L343.855954 557.698808C343.403652 558.118364 343.532589 558.736441 343.207178 559.224558M896.010489 233.486752l-43.524283 43.493583-70.560032-71.681576 42.909276-42.908252c6.783497-6.815219 19.927865-5.824659 27.717272 1.995447l41.412179 41.447994c4.321422 4.317329 6.785543 10.061147 6.785543 15.740496C900.718721 226.234581 899.060965 230.453672 896.010489 233.486752M421.137061 566.105269l316.191382-316.211848 70.596871 71.730695L492.316194 637.21584 421.137061 566.105269zM363.525945 694.308139l22.849404-83.869153 60.953234 60.95528L363.525945 694.308139zM923.762553 407.114185c-16.585747 0-30.18651 13.486152-30.248931 30.29805l0 408.484392c0 21.421892-17.398252 38.819121-38.85289 38.819121L163.658895 884.715747c-21.420869 0-38.884612-17.396205-38.884612-38.819121L124.774283 179.170682c0-21.439288 17.46272-38.850843 38.884612-38.850843l445.046099 0c16.680914 0 30.218232-13.549597 30.218232-30.234605 0-16.649192-13.537318-30.216185-30.218232-30.216185L159.049924 79.869049c-52.222385 0-94.725408 42.470277-94.725408 94.725408l0 675.913187c0 52.254108 42.504046 94.709035 94.725408 94.709035l700.18601 0c52.258201 0 94.743828-42.453904 94.743828-94.709035L953.979762 437.217806C953.912224 420.600337 940.3483 407.114185 923.762553 407.114185" p-id="15995" fill="#f759ab"></path></svg>
                        write
                    </div>
                </Button>
                <Button color="#00ffff" style={{ width: 84, height: 80, margin: 16 }} onClick={() => update('send')}>
                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center'}}>
                        <svg style={{display: 'block'}} viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="16939" width="40" height="40"><path d="M85.333333 896l896-384L85.333333 128v298.666667l640 85.333333-640 85.333333z" p-id="16940" fill="#00ffff"></path></svg>
                        send
                    </div>
                </Button>
                <Button color="#7e57c2" style={{ width: 84, height: 80, margin: 16 }} onClick={() => update('audit')}>
                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center'}}>
                        <svg style={{display: 'block'}} viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="17692" width="40" height="40"><path d="M265.142857 212.571429c-5.028571 0-9.142857 4.114286-9.142857 9.142857v54.857143c0 5.028571 4.114286 9.142857 9.142857 9.142857h438.857143c5.028571 0 9.142857-4.114286 9.142857-9.142857v-54.857143c0-5.028571-4.114286-9.142857-9.142857-9.142857H265.142857z m210.285714 164.571428H265.142857c-5.028571 0-9.142857 4.114286-9.142857 9.142857v54.857143c0 5.028571 4.114286 9.142857 9.142857 9.142857h210.285714c5.028571 0 9.142857-4.114286 9.142858-9.142857v-54.857143c0-5.028571-4.114286-9.142857-9.142858-9.142857z m-54.857142 523.428572H164.571429V96h640v365.714286c0 5.028571 4.114286 9.142857 9.142857 9.142857h64c5.028571 0 9.142857-4.114286 9.142857-9.142857V50.285714c0-20.228571-16.342857-36.571429-36.571429-36.571428H118.857143c-20.228571 0-36.571429 16.342857-36.571429 36.571428v896c0 20.228571 16.342857 36.571429 36.571429 36.571429h301.714286c5.028571 0 9.142857-4.114286 9.142857-9.142857v-64c0-5.028571-4.114286-9.142857-9.142857-9.142857z m502.857142-100.571429H758.857143v-41.828571c52.914286-15.771429 91.428571-64.685714 91.428571-122.742858 0-70.742857-57.257143-128-128-128s-128 57.257143-128 128c0 57.942857 38.514286 106.971429 91.428572 122.742858V800H521.142857c-10.057143 0-18.285714 8.228571-18.285714 18.285714v173.714286c0 10.057143 8.228571 18.285714 18.285714 18.285714h402.285714c10.057143 0 18.285714-8.228571 18.285715-18.285714V818.285714c0-10.057143-8.228571-18.285714-18.285715-18.285714zM665.142857 635.428571c0-31.542857 25.6-57.142857 57.142857-57.142857s57.142857 25.6 57.142857 57.142857-25.6 57.142857-57.142857 57.142858-57.142857-25.6-57.142857-57.142858z m205.714286 304H573.714286v-68.571428h297.142857v68.571428z" p-id="17693" fill="#7e57c2"></path></svg>
                        audit
                    </div>
                </Button>
                <Button color="#ffa340" style={{ width: 84, height: 80, margin: 16 }} onClick={() => update('record')}>
                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center'}}>
                        <svg style={{display: 'block'}} viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18899" width="40" height="40"><path d="M822.857143 201.142857h-73.142857a18.285714 18.285714 0 1 1 0-36.571428H841.142857a18.285714 18.285714 0 0 1 18.285714 18.285714v694.857143a18.285714 18.285714 0 0 1-18.285714 18.285714H182.857143a18.285714 18.285714 0 0 1-18.285714-18.285714V182.857143a18.285714 18.285714 0 0 1 18.285714-18.285714h91.428571a18.285714 18.285714 0 0 1 0 36.571428h-73.142857v658.285714h621.714286v-658.285714zM365.714286 128h292.571428a18.285714 18.285714 0 0 1 18.285715 18.285714v109.714286a18.285714 18.285714 0 0 1-18.285715 18.285714h-292.571428a18.285714 18.285714 0 0 1-18.285715-18.285714V146.285714a18.285714 18.285714 0 0 1 18.285715-18.285714z m18.285714 36.571429v73.142857h256v-73.142857h-256z m-18.285714 365.714285a18.285714 18.285714 0 1 1 0-36.571428h292.571428a18.285714 18.285714 0 1 1 0 36.571428h-292.571428z m0 146.285715a18.285714 18.285714 0 1 1 0-36.571429h292.571428a18.285714 18.285714 0 1 1 0 36.571429h-292.571428z" p-id="18900" fill="#ffa340"></path></svg>
                        record
                    </div>
                </Button>
                <Button color="#01ca83" style={{ width: 84, height: 80, margin: 16 }} onClick={() => update('work')}>
                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center'}}>
                        <svg style={{display: 'block'}} viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="21625" width="40" height="40"><path d="M1012.224 252.416L760.832 12.8c-6.144-5.632-13.312-8.704-21.504-8.704h-465.92c-47.616 0-86.016 38.4-86.016 86.016v177.664H87.552C40.448 267.776 2.56 305.664 2.56 352.768v439.296c0 47.104 37.888 84.992 84.992 84.992h99.84v57.344c0 47.616 38.4 86.016 86.016 86.016h662.016c47.616 0 86.016-38.4 86.016-86.016V274.944c0-8.704-3.072-16.384-9.216-22.528z m-256.512-159.744l167.424 159.232-167.424-4.608V92.672zM87.552 815.616c-12.8 0-23.552-10.752-23.552-23.552V352.256c0-12.8 10.752-23.552 23.552-23.552H522.24c12.8 0 23.552 10.752 23.552 23.552v439.296c0 12.8-10.752 23.552-23.552 23.552H87.552z m872.448 118.272c0 13.312-11.264 24.576-24.576 24.576H273.408c-13.312 0-24.576-11.264-24.576-24.576v-57.344H522.24c47.104 0 84.992-37.888 84.992-84.992v-53.248h143.36c16.896 0 30.72-13.824 30.72-30.72s-13.824-30.72-30.72-30.72h-143.36v-81.92h143.36c16.896 0 30.72-13.824 30.72-30.72s-13.824-30.72-30.72-30.72h-143.36v-81.92h143.36c16.896 0 30.72-13.824 30.72-30.72s-13.824-30.72-30.72-30.72h-143.36v-37.888c0-47.104-37.888-84.992-84.992-84.992H248.832V89.6c0-13.312 11.264-24.576 24.576-24.576h420.864v212.48c0 16.896 12.8 30.208 29.696 30.72l236.032 6.144v619.52z" fill="#01ca83" p-id="21626"></path><path d="M391.68 589.824l-42.496-112.128H268.8l-41.984 112.128-29.184-112.128H116.736l60.928 200.192H261.12l48.128-125.952 48.128 125.952h83.456l60.416-200.192H420.864z" fill="#01ca83" p-id="21627"></path></svg>
                        work
                    </div>
                </Button>
                <Button color="#4c7d9e" style={{ width: 84, height: 80, margin: 16 }} onClick={() => update('operation')}>
                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center'}}>
                        <svg style={{display: 'block'}} viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="22625" width="40" height="40"><path d="M571.178667 643.328a144 144 0 0 1-189.098667-193.450667l77.781333 77.866667a48 48 0 1 0 67.882667-67.84l-77.824-77.909333a144 144 0 0 1 193.450667 189.141333l226.517333 207.061333a64.896 64.896 0 1 1-91.690667 91.690667l-207.018666-226.56z m51.498666 134.656a288.298667 288.298667 0 0 1-38.656 12.928v95.488c0 5.290667-4.309333 9.6-9.642666 9.6h-124.757334a9.6 9.6 0 0 1-9.6-9.6v-95.488a286.293333 286.293333 0 0 1-74.325333-30.805333l-67.541333 67.541333a9.6 9.6 0 0 1-13.568 0L196.352 739.413333a9.6 9.6 0 0 1 0-13.568l67.541333-67.541333a286.293333 286.293333 0 0 1-30.805333-74.325333H137.6A9.6 9.6 0 0 1 128 574.378667v-124.757334c0-5.290667 4.309333-9.6 9.6-9.6h95.488c6.826667-26.453333 17.28-51.370667 30.805333-74.325333L196.352 298.154667a9.6 9.6 0 0 1 0-13.568L284.586667 196.352a9.6 9.6 0 0 1 13.568 0l67.541333 67.498667a287.146667 287.146667 0 0 1 74.325333-30.848V137.6c0-5.290667 4.266667-9.6 9.6-9.6h124.8c5.248 0 9.6 4.309333 9.6 9.6v95.488c26.368 6.826667 51.328 17.28 74.282667 30.805333l67.541333-67.541333a9.6 9.6 0 0 1 13.568 0l88.234667 88.234667a9.6 9.6 0 0 1 0 13.568l-67.498667 67.541333a287.146667 287.146667 0 0 1 30.848 74.282667h95.402667c5.290667 0 9.6 4.352 9.6 9.642666v124.757334c0 5.333333-4.266667 9.6-9.6 9.6h-95.488c-4.693333 18.133333-11.178667 35.754667-19.328 52.650666a9.6 9.6 0 0 1-15.018667 2.986667l-10.112-9.173333-38.314666-34.261334-12.16-10.88a9.6 9.6 0 0 1-2.688-10.24A192.298667 192.298667 0 0 0 512 320a192 192 0 1 0 63.018667 373.333333 9.6 9.6 0 0 1 10.24 2.645334l10.837333 12.074666 35.285333 39.338667 8.149334 9.130667a9.6 9.6 0 0 1-2.901334 15.061333 283.306667 283.306667 0 0 1-13.952 6.4z" p-id="22626" fill="#4c7d9e"></path></svg>
                        operation
                    </div>
                </Button>
                {canAddBranch && 
                    <Button color="#8c8c8c" style={{ width: 84, height: 80, margin: 16 }} onClick={() => update('addBranch')}>
                        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center'}}>
                            <svg style={{display: 'block'}} viewBox="0 0 1170 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23363" width="40" height="40"><path d="M619.556571 546.139429v139.940571c78.555429 15.817143 137.691429 84.681143 137.691429 167.259429C757.248 947.565714 680.192 1024 585.142857 1024s-172.105143-76.416-172.105143-170.660571c0-82.578286 59.136-151.442286 137.691429-167.259429v-139.940571H240.932571c-19.017143 0-34.413714 15.268571-34.413714 34.121142v105.819429c78.555429 15.817143 137.691429 84.681143 137.691429 167.259429C344.210286 947.565714 267.154286 1024 172.105143 1024S0 947.584 0 853.339429c0-82.578286 59.117714-151.442286 137.691429-167.259429v-105.819429c0-56.539429 46.226286-102.4 103.241142-102.4h309.796572V337.92c-78.555429-15.817143-137.691429-84.681143-137.691429-167.259429C413.037714 76.434286 490.093714 0 585.142857 0s172.105143 76.416 172.105143 170.660571c0 82.578286-59.136 151.442286-137.691429 167.259429v139.940571h309.796572c57.014857 0 103.259429 45.860571 103.259428 102.4v105.819429c78.555429 15.817143 137.673143 84.681143 137.673143 167.259429C1170.285714 947.565714 1093.229714 1024 998.180571 1024s-172.105143-76.416-172.105142-170.660571c0-82.578286 59.136-151.442286 137.691428-167.259429v-105.819429c0-18.834286-15.414857-34.121143-34.413714-34.121142H619.556571zM585.142857 273.060571c57.033143 0 103.259429-45.842286 103.259429-102.4 0-56.539429-46.226286-102.4-103.259429-102.4s-103.259429 45.860571-103.259428 102.4c0 56.557714 46.226286 102.4 103.259428 102.4zM172.105143 955.739429c57.033143 0 103.259429-45.860571 103.259428-102.4 0-56.557714-46.226286-102.4-103.259428-102.4s-103.259429 45.842286-103.259429 102.4c0 56.539429 46.226286 102.4 103.259429 102.4z m413.037714 0c57.033143 0 103.259429-45.860571 103.259429-102.4 0-56.557714-46.226286-102.4-103.259429-102.4s-103.259429 45.842286-103.259428 102.4c0 56.539429 46.226286 102.4 103.259428 102.4z m413.037714 0c57.033143 0 103.259429-45.860571 103.259429-102.4 0-56.557714-46.226286-102.4-103.259429-102.4s-103.259429 45.842286-103.259428 102.4c0 56.539429 46.226286 102.4 103.259428 102.4z" p-id="23364" fill="#8c8c8c"></path></svg>
                            branch
                        </div>
                    </Button>
                }
            </div>
            <div>
                <Button color="#ff3b3b" variant="text" onClick={cancel}>Cancel</Button>
            </div>
        </div>
    );
}

const initData = {
    head: {
        id: 'head',
        next: ['tail'],
        type: 'start',
        title: '定时触发'
    },
    tail: {
        id: 'tail',
        pre: ['head'],
        type: 'end',
    }
}


function Demo() {
    const [data, setData] = useState(cloneDeep(initData));

    const onChange = useCallback(({ type, target }) => {
        if (type === 'add' || type === 'combineNodes') {
            const newNode = createNewNode('temp');
            let newData = type === 'combineNodes' ? combineNodes(data, target, newNode) : addNode(data, target, newNode);
            setData(newData);
            const update = (nodeType) => {
                if (nodeType === 'addBranch') {
                    newData = deleteNode(newData, newNode.id);
                    newData = addBranch(newData, target, [createNewNode('condition'), createNewNode('condition')]);
                    setData(newData);
                    Toast.hide(toastId);
                } else {
                    newData[newNode.id].type = nodeType;
                    newData[newNode.id].title = nodeTitleMap[nodeType];
                    setData({...newData});
                    Toast.hide(toastId);
                }
            }
            const cancel = () => {
                newData = deleteNode(newData, newNode.id);
                setData(newData);
                Toast.hide(toastId);
            }
            Toast.setListStyle({ left: '100vw', top: '0', transform: 'translate(-100%, 0)'}, );
            toastId = Toast.show({ Content: ToastPanel(update, cancel, type === 'combineNodes' ? false : newNode.next.length === 1), showMask: true, duration: 0 });
        } else if (type === 'expandBranch') {
            const newData = expandBranch(data, target, [createNewNode('condition')]);
            setData(newData);
        } else if (type === 'deleteNode') {
            let newData = data;
            newData[target].selected = true;
            setData({...newData});
            Toast.setListStyle({ left: '50%', top: '15%', transform: 'translate(-50%, -50%)'});
            toastId = Toast.show({
                Content: ToastConfirmDelete(
                    () => {
                        newData = deleteNode(data, target);
                        setData({...newData});
                        Toast.hide(toastId);
                    }, 
                    () => {
                        delete newData[target].selected;
                        setData({...newData});
                        Toast.hide(toastId);
                    }
                ),
                showMask: true
            });
        }
    }, [data]);

    return (
        <div className={styles.flowchartContainer} style={{ backgroundColor: "#f0f0f0" }}>
            <FlowChart
                data={data}
                onChange={onChange}
                backgroundColor='#f0f0f0'
                config={{
                    lineWidth: 1,
                    lineColor: '#ccc',
                    distance: { horizontal: 50, vertical: 40 },
                    padding: { top: 36, left: 36, right: 36, bottom: 24 },
                    brotherNodeAlign: 'center' // top bottom
                }}
                headNodeId= 'head'
                RenderNode={Render}
                showAddButton={true}
                showBranchButton={true}
                showCombineButton={true}
                // RenderAddButton={RenderAddButton}
                // RenderBranchButton={RenderBranchButton}
                // RenderCombineButton={RenderMergeButton}
            />
        </div>
    );
}

export default Demo;
